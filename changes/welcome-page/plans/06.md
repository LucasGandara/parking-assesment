# Plan: Registration Page

## Objective

Build the registration page inside the auth layout. Six fields in order,
searchable building dropdown with Convex query + loading/empty/error states,
phone hint text, full Zod-based client-side validation, Convex Auth sign-up
integration, and redirect on success.

## Requirements

- **From specs/auth/registration.md**: "The system SHALL render the following
  fields on the registration page in order: first name, last name, email,
  password, building, phone number."
- **From specs/auth/registration.md**: "The system SHALL render a 'Create
  Account' submit button on the registration page."
- **From specs/auth/registration.md**: "The system SHALL render an 'Already
  have an account? Sign in' navigation link on the registration page."
- **From specs/auth/registration.md**: "WHEN a user activates the 'Already
  have an account? Sign in' link the system SHALL navigate to `/login`."
- **From specs/auth/registration.md**: "The system SHALL render the building
  field as a searchable dropdown."
- **From specs/auth/registration.md**: "WHEN the registration page loads the
  system SHALL fetch the list of available buildings from Convex."
- **From specs/auth/registration.md**: "WHILE the building list is being
  fetched the system SHALL render the building dropdown as non-interactive
  and display a loading indicator within it."
- **From specs/auth/registration.md**: "IF the building list fetch completes
  and returns no buildings THEN the system SHALL display the message 'No
  buildings available. Contact your administrator.' inside the building
  dropdown."
- **From specs/auth/registration.md**: "IF the building list fetch fails THEN
  the system SHALL display an error message inside the building dropdown."
- **From specs/auth/registration.md**: "The system SHALL display the hint
  text '10 digits, no spaces or dashes' beneath the phone number field at
  all times."
- **From specs/auth/registration.md**: "WHEN a user submits the registration
  form the system SHALL validate all fields before sending the registration
  request."
- **From specs/auth/registration.md**: "IF any required field has no value
  THEN the system SHALL display an inline error message beneath that field."
- **From specs/auth/registration.md**: "IF the email value does not end with
  `@unosquare.com` THEN the system SHALL display the error 'Only
  @unosquare.com email addresses are accepted.' beneath the email field."
- **From specs/auth/registration.md**: "IF the password value contains fewer
  than 8 characters THEN the system SHALL display the error 'Password must
  be at least 8 characters.' beneath the password field."
- **From specs/auth/registration.md**: "IF the phone number value does not
  consist of exactly 10 numeric digits THEN the system SHALL display the
  error 'Phone number must be exactly 10 digits.' beneath the phone number
  field."
- **From specs/auth/registration.md**: "IF any validation rule fails THEN the
  system SHALL not submit the registration request to Convex Auth."
- **From specs/auth/registration.md**: "WHEN all form validation passes the
  system SHALL submit the registration request to Convex Auth."
- **From specs/auth/registration.md**: "The system SHALL enforce the
  `@unosquare.com` email domain restriction in the Convex Auth sign-up
  handler independently of client-side validation."
- **From specs/auth/registration.md**: "IF the Convex Auth sign-up handler
  rejects the email domain THEN the system SHALL display the error 'Only
  @unosquare.com email addresses are accepted.' beneath the email field."
- **From specs/auth/registration.md**: "IF the submitted email address is
  already associated with an existing account THEN the system SHALL display
  the error 'An account with this email already exists.' beneath the email
  field."
- **From specs/auth/registration.md**: "WHEN registration succeeds the system
  SHALL authenticate the user immediately without requiring email
  verification."
- **From specs/auth/registration.md**: "WHEN registration succeeds the system
  SHALL redirect the user to the main application dashboard."

## Research Findings

- `convex/auth.ts` — `profile()` currently returns only `{ email,
  emailVerificationTime }`. The `users` schema also requires `firstName`,
  `lastName`, `phone`, `buildingId`, `role`. Must extend `profile()` as part
  of this task.
- `convex/buildings.ts` — does not exist yet. The `_generated/api.d.ts` only
  includes `auth` and `http`. A new public `list` query is needed; types
  will be regenerated by `convex dev`.
- No `src/features/auth/utils/` directory yet — must create it.
- Login pattern: `FormData` for text fields, `useState` for submit/error
  state, `useAuthActions().signIn`. Follow same pattern.
- SCSS: `login.module.scss` uses underscore-block BEM (`.login_form__field`).
  Register module will use `.register_form` as the block.
- `SubmitEvent` is imported from `"react"` in login — follow the same import.
- Zod is not installed — must add it.

## Steps

### Step 1 — Install Zod

```bash
pnpm --filter parking-raffler add zod
```

No code changes; just adds `zod` to `apps/parking-raffler/package.json`.

---

### Step 2 — Convex buildings query

**File:** `convex/buildings.ts` (create)

```ts
import { query } from "./_generated/server";

export const list = query({
  args: {},
  handler: async (ctx) => {
    return ctx.db.query("buildings").collect();
  },
});
```

After creating this file, `convex dev` (run via `pnpm dev`) will regenerate
`convex/_generated/api.d.ts` to include `api.buildings.list`.

---

### Step 3 — Extend auth profile()

**File:** `convex/auth.ts` (update)

Extend `profile()` to return all required user fields. The extra params
(`firstName`, `lastName`, `phone`, `buildingId`) are passed from the client
during sign-up via `signIn("password", { flow: "signUp", ... })`.

```ts
import { Password } from "@convex-dev/auth/providers/Password";
import { convexAuth } from "@convex-dev/auth/server";
import { ConvexError } from "convex/values";

import type { Id } from "./_generated/dataModel";

const ALLOWED_DOMAIN = "@unosquare.com";

export const {
  auth,
  isAuthenticated,
  signIn,
  signOut,
  store,
} = convexAuth({
  providers: [
    Password({
      profile(params) {
        const email = String(params.email ?? "");
        if (!email.endsWith(ALLOWED_DOMAIN)) {
          throw new ConvexError(
            "Only @unosquare.com email addresses are accepted.",
          );
        }
        return {
          buildingId: params.buildingId as Id<"buildings">,
          email,
          emailVerificationTime: Date.now(),
          firstName: String(params.firstName ?? ""),
          lastName: String(params.lastName ?? ""),
          phone: String(params.phone ?? ""),
          role: "resident" as const,
        };
      },
    }),
  ],
});
```

---

### Step 4 — Validation schema

**File:** `src/features/auth/utils/validation.ts` (create)

```ts
import { z } from "zod";

export const registerSchema = z.object({
  buildingId: z.string().min(1, "This field is required."),
  email: z
    .string()
    .min(1, "This field is required.")
    .endsWith(
      "@unosquare.com",
      "Only @unosquare.com email addresses are accepted.",
    ),
  firstName: z.string().min(1, "This field is required."),
  lastName: z.string().min(1, "This field is required."),
  password: z
    .string()
    .min(1, "This field is required.")
    .min(8, "Password must be at least 8 characters."),
  phone: z
    .string()
    .min(1, "This field is required.")
    .regex(/^\d{10}$/, "Phone number must be exactly 10 digits."),
});

export type RegisterFormData = z.infer<typeof registerSchema>;
```

---

### Step 5 — Registration form component

**File:** `src/routes/register/index.tsx` (update — replace placeholder)

Full replacement. Keep the existing route config (`createFileRoute`,
`beforeLoad` auth guard, `ADMIN_EMAIL`) unchanged.

#### Imports (alphabetical order per convention):

```ts
import type { SubmitEvent } from "react";

import { useAuthActions } from "@convex-dev/auth/react";
import {
  createFileRoute,
  Link,
  redirect,
  useNavigate,
} from "@tanstack/react-router";
import { useQuery } from "convex/react";

import { AuthLayout }
  from "app/features/auth/components/auth-layout/auth-layout";
import { registerSchema }
  from "app/features/auth/utils/validation";

import { useState } from "react";

import { api } from "../../../convex/_generated/api";
import styles from "./register.module.scss";
```

> Note: `api` import path depends on tsconfig aliases. Check existing imports
> in the project. If there's a `convex/` path alias use `convex/_generated/api`,
> otherwise use the relative path from `src/routes/register/`.

#### Error state type:

```ts
type FormErrors = {
  buildingId?: string;
  email?: string;
  firstName?: string;
  lastName?: string;
  password?: string;
  phone?: string;
  submit?: string;
};
```

#### Building dropdown error boundary:

A minimal class-based ErrorBoundary wraps the building combobox so that
Convex query errors are caught and displayed inline instead of crashing the
page.

```tsx
import { Component } from "react";
import type { ReactNode } from "react";

type EBProps = { children: ReactNode; fallback: ReactNode };
type EBState = { hasError: boolean };

class BuildingErrorBoundary
  extends Component<EBProps, EBState> {
  state: EBState = { hasError: false };
  static getDerivedStateFromError() {
    return { hasError: true };
  }
  render() {
    return this.state.hasError
      ? this.props.fallback
      : this.props.children;
  }
}
```

#### BuildingField component (searchable combobox):

A separate function inside the same file. Uses `useQuery(api.buildings.list)`
internally.

```tsx
type BuildingFieldProps = {
  error?: string;
  onChange: (id: string) => void;
};

function BuildingField({ error, onChange }: BuildingFieldProps) {
  const buildings = useQuery(api.buildings.list);
  const [search, setSearch] = useState("");
  const [isOpen, setIsOpen] = useState(false);
  const [selectedName, setSelectedName] = useState("");

  const isLoading = buildings === undefined;
  const filtered = (buildings ?? []).filter((b) =>
    b.name.toLowerCase().includes(search.toLowerCase()),
  );

  function select(id: string, name: string) {
    onChange(id);
    setSelectedName(name);
    setSearch("");
    setIsOpen(false);
  }

  return (
    <div className={styles.register_form__field}>
      <label
        className={styles.register_form__label}
        htmlFor="building-search"
      >
        Building
      </label>
      <div className={styles.register_form__combobox}>
        <input
          autoComplete="off"
          className={styles.register_form__input}
          disabled={isLoading}
          id="building-search"
          onChange={(e) => {
            setSearch(e.target.value);
            setIsOpen(true);
          }}
          onFocus={() => setIsOpen(true)}
          placeholder={isLoading ? "Loading…" : "Search buildings…"}
          type="text"
          value={isOpen ? search : selectedName}
        />
        {isOpen && !isLoading && (
          <ul
            className={styles.register_form__dropdown}
            role="listbox"
          >
            {filtered.length === 0 ? (
              <li className={styles.register_form__dropdown_empty}>
                No buildings available.
                {" "}
                Contact your administrator.
              </li>
            ) : (
              filtered.map((b) => (
                <li
                  className={styles.register_form__dropdown_item}
                  key={b._id}
                  onClick={() => select(b._id, b.name)}
                  role="option"
                  aria-selected={selectedName === b.name}
                >
                  {b.name}
                </li>
              ))
            )}
          </ul>
        )}
      </div>
      {error !== undefined && (
        <p className={styles.register_form__error} role="alert">
          {error}
        </p>
      )}
    </div>
  );
}
```

The error boundary fallback renders the error inline in the dropdown slot:

```tsx
const BUILDING_FETCH_ERROR = (
  <p className={styles.register_form__error} role="alert">
    Failed to load buildings. Please refresh and try again.
  </p>
);
```

#### RegisterForm component:

```tsx
export function RegisterForm() {
  const { signIn } = useAuthActions();
  const navigate = useNavigate();
  const [errors, setErrors] = useState<FormErrors>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [buildingId, setBuildingId] = useState("");

  async function handleSubmit(
    event: SubmitEvent<HTMLFormElement>,
  ) {
    event.preventDefault();
    const data = new FormData(event.currentTarget);

    const raw = {
      buildingId,
      email: String(data.get("email") ?? ""),
      firstName: String(data.get("firstName") ?? ""),
      lastName: String(data.get("lastName") ?? ""),
      password: String(data.get("password") ?? ""),
      phone: String(data.get("phone") ?? ""),
    };

    const result = registerSchema.safeParse(raw);
    if (!result.success) {
      const fieldErrors: FormErrors = {};
      const flat = result.error.flatten().fieldErrors;
      for (const key of Object.keys(flat)) {
        const msgs = flat[key as keyof typeof flat];
        if (msgs?.[0] !== undefined) {
          fieldErrors[key as keyof FormErrors] = msgs[0];
        }
      }
      setErrors(fieldErrors);
      return;
    }

    setErrors({});
    setIsSubmitting(true);
    try {
      await signIn("password", {
        buildingId: result.data.buildingId,
        email: result.data.email,
        firstName: result.data.firstName,
        flow: "signUp",
        lastName: result.data.lastName,
        password: result.data.password,
        phone: result.data.phone,
      });
      await navigate({ to: "/" });
    } catch (err) {
      const msg = err instanceof Error ? err.message : "";
      if (msg.includes("Only @unosquare.com")) {
        setErrors({
          email:
            "Only @unosquare.com email addresses are accepted.",
        });
      } else if (
        msg.includes("already exists") ||
        msg.includes("duplicate")
      ) {
        setErrors({
          email:
            "An account with this email already exists.",
        });
      } else {
        setErrors({
          submit: "Something went wrong. Please try again.",
        });
      }
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <form
      className={styles.register_form}
      onSubmit={handleSubmit}
    >
      <div className={styles.register_form__header}>
        <h2 className={styles.register_form__title}>
          Create account
        </h2>
        <p className={styles.register_form__subtitle}>
          Join your building's parking system
        </p>
      </div>

      <div className={styles.register_form__fields}>
        {/* First name */}
        <div className={styles.register_form__field}>
          <label
            className={styles.register_form__label}
            htmlFor="firstName"
          >
            First name
          </label>
          <input
            autoComplete="given-name"
            className={styles.register_form__input}
            id="firstName"
            name="firstName"
            type="text"
          />
          {errors.firstName !== undefined && (
            <p
              className={styles.register_form__error}
              role="alert"
            >
              {errors.firstName}
            </p>
          )}
        </div>

        {/* Last name */}
        <div className={styles.register_form__field}>
          <label
            className={styles.register_form__label}
            htmlFor="lastName"
          >
            Last name
          </label>
          <input
            autoComplete="family-name"
            className={styles.register_form__input}
            id="lastName"
            name="lastName"
            type="text"
          />
          {errors.lastName !== undefined && (
            <p
              className={styles.register_form__error}
              role="alert"
            >
              {errors.lastName}
            </p>
          )}
        </div>

        {/* Email */}
        <div className={styles.register_form__field}>
          <label
            className={styles.register_form__label}
            htmlFor="email"
          >
            Email
          </label>
          <input
            autoComplete="email"
            className={styles.register_form__input}
            id="email"
            name="email"
            type="email"
          />
          {errors.email !== undefined && (
            <p
              className={styles.register_form__error}
              role="alert"
            >
              {errors.email}
            </p>
          )}
        </div>

        {/* Password */}
        <div className={styles.register_form__field}>
          <label
            className={styles.register_form__label}
            htmlFor="password"
          >
            Password
          </label>
          <input
            autoComplete="new-password"
            className={styles.register_form__input}
            id="password"
            name="password"
            type="password"
          />
          {errors.password !== undefined && (
            <p
              className={styles.register_form__error}
              role="alert"
            >
              {errors.password}
            </p>
          )}
        </div>

        {/* Building */}
        <BuildingErrorBoundary fallback={BUILDING_FETCH_ERROR}>
          <BuildingField
            error={errors.buildingId}
            onChange={setBuildingId}
          />
        </BuildingErrorBoundary>

        {/* Phone */}
        <div className={styles.register_form__field}>
          <label
            className={styles.register_form__label}
            htmlFor="phone"
          >
            Phone number
          </label>
          <input
            autoComplete="tel"
            className={styles.register_form__input}
            id="phone"
            name="phone"
            type="tel"
          />
          <p className={styles.register_form__hint}>
            10 digits, no spaces or dashes
          </p>
          {errors.phone !== undefined && (
            <p
              className={styles.register_form__error}
              role="alert"
            >
              {errors.phone}
            </p>
          )}
        </div>

        {errors.submit !== undefined && (
          <p
            className={styles.register_form__error}
            role="alert"
          >
            {errors.submit}
          </p>
        )}
      </div>

      <button
        className={styles.register_form__submit}
        disabled={isSubmitting}
        type="submit"
      >
        {isSubmitting ? "Creating account\u2026" : "Create Account"}
      </button>

      <p className={styles.register_form__signin}>
        {"Already have an account? "}
        <Link
          className={styles.register_form__signin_link}
          to="/login"
        >
          Sign in
        </Link>
      </p>
    </form>
  );
}
```

RegisterPage (keep route config, replace placeholder):

```tsx
function RegisterPage() {
  return (
    <AuthLayout adminEmail={ADMIN_EMAIL}>
      <RegisterForm />
    </AuthLayout>
  );
}
```

---

### Step 6 — SCSS module

**File:** `src/routes/register/register.module.scss` (create)

Mirror `login.module.scss` structure, add combobox dropdown and hint styles.

```scss
@use "variables" as *;

.register_form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;

  &__header { text-align: center; }

  &__title {
    color: $color_text;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
  }

  &__subtitle {
    color: $color_text_muted;
    font-size: 0.875rem;
    margin: 0;
  }

  &__fields {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  &__field {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  &__label {
    color: $color_text;
    font-size: 0.875rem;
    font-weight: 500;
  }

  &__input {
    border: 1px solid $color_border_input;
    border-radius: $radius_sm;
    font-size: 0.875rem;
    outline: none;
    padding: 0.625rem 0.75rem;
    width: 100%;

    &:focus {
      border-color: $color_primary;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    &:disabled {
      background-color: $color_bg;
      cursor: not-allowed;
    }
  }

  &__hint {
    color: $color_text_muted;
    font-size: 0.75rem;
    margin: 0;
  }

  &__error {
    color: $color_error;
    font-size: 0.875rem;
    margin: 0;
  }

  /* Combobox */
  &__combobox { position: relative; }

  &__dropdown {
    background: $color_white;
    border: 1px solid $color_border_input;
    border-radius: $radius_sm;
    box-shadow: $shadow_card;
    left: 0;
    list-style: none;
    margin: 0.25rem 0 0;
    max-height: 12rem;
    overflow-y: auto;
    padding: 0.25rem 0;
    position: absolute;
    right: 0;
    z-index: 10;
  }

  &__dropdown_item {
    cursor: pointer;
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;

    &:hover { background-color: $color_primary_light; }
  }

  &__dropdown_empty {
    color: $color_text_muted;
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
  }

  /* Submit button */
  &__submit {
    background-color: $color_primary;
    border-radius: $radius_sm;
    color: $color_white;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.625rem 1rem;
    width: 100%;

    &:hover:not(:disabled) {
      background-color: $color_primary_dark;
    }

    &:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }
  }

  /* Sign-in link */
  &__signin {
    color: $color_text_muted;
    font-size: 0.875rem;
    margin: 0;
    text-align: center;
  }

  &__signin_link {
    color: $color_primary;
    font-weight: 500;
    text-decoration: none;

    &:hover { text-decoration: underline; }
  }
}
```

---

## Validation

- [ ] `/register` renders all six fields in order: first name, last name,
  email, password, building, phone
- [ ] Building dropdown shows "Loading…" placeholder while fetching
- [ ] Building dropdown shows "No buildings available. Contact your
  administrator." when list is empty
- [ ] Phone field shows hint text at all times
- [ ] Submitting empty form shows "This field is required." under each field
- [ ] Submitting `bad@gmail.com` shows domain error under email
- [ ] Submitting a password < 8 chars shows length error under password
- [ ] Submitting an invalid phone shows format error under phone
- [ ] Successful sign-up redirects to "/"
- [ ] "Already have an account? Sign in" navigates to `/login`
- [ ] `pnpm lint` and `pnpm check-types` pass
