# Plan: Project Scaffolding

## Objective

Initialize the Vite + React + TypeScript project, install all required
dependencies, and establish the base directory structure. This task produces
a working (if empty) application that can be committed and built upon.

## Requirements

- **Foundations & Prerequisites (tasks.md Task 1)**:
  - Initialize Vite project with React + TypeScript template via `pnpm create vite`
  - Install runtime and dev dependencies (see Step 2)
  - Create directory structure: `src/auth/components/`, `src/auth/hooks/`,
    `src/auth/utils/`, `src/shared/components/`, `src/shared/hooks/`,
    `src/shared/utils/`, `convex/`
  - Configure `tsconfig.json` (strict mode, path aliases)
  - Create minimal `src/main.tsx` and `src/App.tsx` entry points
  - Configure Vitest and Playwright

## Research Findings

- **TanStack Router** (code-based): Requires `@tanstack/react-router` +
  `@tanstack/router-plugin` (Vite plugin). The Vite plugin must be registered
  before the React plugin in `vite.config.ts`. Route definitions use
  `createRootRoute`, `createRoute`, `createRouter`, and `RouterProvider`.
  Wiring to the router happens in Task 3 — only the package needs to be
  installed here.
- **Convex Auth**: Requires `convex` + `@convex-dev/auth`. The `profile()`
  callback in the Password provider is where the `@unosquare.com` domain
  restriction will be enforced (Task 2). Only packages are installed here.
- **Vitest**: Configured inside `vite.config.ts` using a `test` block.
  Requires `@vitest/ui` is optional; `jsdom` environment needs
  `@testing-library/jest-dom` in a setup file.
- **Playwright**: Configured in a separate `playwright.config.ts` at project
  root. Dev server runs on `http://localhost:5173` by default.
- **Path alias**: `@/*` → `src/*` is the standard Vite+TS convention.
  Requires both `vite.config.ts` `resolve.aliases` and `tsconfig.json`
  `compilerOptions.paths`.
- **Existing repo**: The repository already exists as a git repo with a
  `CLAUDE.md` and `.claude/` directory. Vite scaffolding must target `.`
  (current directory) to avoid creating a nested subfolder.

## Steps

### Step 1: Scaffold Vite project

**Command (run in project root):**

```bash
pnpm create vite . --template react-ts
```

This generates: `index.html`, `vite.config.ts`, `tsconfig.json`,
`tsconfig.app.json`, `tsconfig.node.json`, `src/main.tsx`, `src/App.tsx`,
`src/App.css`, `src/index.css`, `src/assets/`, `public/`.

After scaffolding, delete the boilerplate styles and assets:

```bash
rm src/App.css src/index.css
rm -rf src/assets
```

> Vite may warn about existing files (CLAUDE.md, .claude/). Confirm overwrite
> only for the generated files, not the existing project files.

---

### Step 2: Install dependencies

**Runtime dependencies:**

```bash
pnpm add @tanstack/react-router convex @convex-dev/auth clsx sass
```

**Dev dependencies:**

```bash
pnpm add -D \
  @tanstack/router-plugin \
  vitest \
  @vitest/coverage-v8 \
  @testing-library/react \
  @testing-library/user-event \
  @testing-library/jest-dom \
  @playwright/test \
  @types/react \
  @types/react-dom \
  jsdom
```

Install Playwright browsers after:

```bash
pnpm exec playwright install chromium
```

---

### Step 3: Create directory structure

```bash
mkdir -p src/auth/components src/auth/hooks src/auth/utils
mkdir -p src/shared/components src/shared/hooks src/shared/utils
mkdir -p convex
```

Add `.gitkeep` to each empty directory so git tracks them:

```bash
touch src/auth/components/.gitkeep
touch src/auth/hooks/.gitkeep
touch src/auth/utils/.gitkeep
touch src/shared/components/.gitkeep
touch src/shared/hooks/.gitkeep
touch src/shared/utils/.gitkeep
touch convex/.gitkeep
```

---

### Step 4: Configure `tsconfig.json` (strict mode + path alias)

**File:** `tsconfig.json`

Replace the generated file entirely:

```json
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
```

**File:** `tsconfig.app.json`

Ensure `compilerOptions` includes:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"]
}
```

**File:** `tsconfig.node.json`

Keep as generated (covers `vite.config.ts`). Ensure it does NOT include `src/`.

---

### Step 5: Configure `vite.config.ts`

```typescript
import { TanStackRouterVite } from '@tanstack/router-plugin/vite';
import react from '@vitejs/plugin-react';
import path from 'path';
import { defineConfig } from 'vite';

export default defineConfig({
  plugins: [
    TanStackRouterVite({ routesDirectory: 'src/routes' }),
    react(),
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['src/test-setup.ts'],
  },
});
```

> `TanStackRouterVite` must come before `react()`. The `routesDirectory`
> points to where file-based routes would live — we're using code-based
> routing but the plugin is still required for the router devtools and
> type generation.
>
> Actually: for **code-based** routing, the `TanStackRouterVite` plugin is
> optional (it's only required for file-based routing). Omit it for now and
> add only if devtools are needed. This simplifies `vite.config.ts`:

```typescript
import react from '@vitejs/plugin-react';
import path from 'path';
import { defineConfig } from 'vite';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['src/test-setup.ts'],
  },
});
```

---

### Step 6: Create Vitest setup file

**File:** `src/test-setup.ts`

```typescript
import '@testing-library/jest-dom';
```

---

### Step 7: Create minimal entry points

**File:** `src/main.tsx`

```tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

ReactDOM.createRoot(
  document.getElementById('root') as HTMLElement
).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

**File:** `src/App.tsx`

```tsx
function App() {
  return <div>ParkSmart AI</div>;
}

export default App;
```

> Router and Convex providers are wired in Tasks 3 and 2 respectively.
> The entry point is intentionally minimal.

---

### Step 8: Configure Playwright

**File:** `playwright.config.ts` (project root)

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

Create the E2E directory:

```bash
mkdir -p e2e
touch e2e/.gitkeep
```

---

### Step 9: Update `package.json` scripts

Ensure `package.json` has:

```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview",
    "test": "vitest",
    "test:e2e": "playwright test"
  }
}
```

> These match the commands documented in `CLAUDE.md`.

---

### Step 10: Verify build

```bash
pnpm build
```

Must succeed with zero TypeScript errors. If it fails, fix before moving on.

---

## Validation

- [ ] `pnpm dev` starts the dev server and renders "ParkSmart AI" in browser
- [ ] `pnpm build` completes with zero errors
- [ ] `pnpm test` runs (no tests yet, but Vitest exits cleanly)
- [ ] Directory structure exists: `src/auth/`, `src/shared/`, `convex/`
- [ ] `@/` path alias resolves correctly in TypeScript
- [ ] Repository is in a committable state
